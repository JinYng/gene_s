# ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è¯´æ˜

## ğŸ“Š æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸŒ å‰ç«¯ (Next.js)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ChatPanel.js    â”‚  SingleCellAnalyzer.js  â”‚  DeckGLScatter â”‚
â”‚  (å¯¹è¯ç•Œé¢)       â”‚  (åˆ†ææ§åˆ¶)              â”‚  (å¯è§†åŒ–)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP APIè°ƒç”¨
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ğŸš€ Node.js APIä¸­é—´å±‚                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  chat-ollama.js: è·¯ç”±åˆ†å‘å’Œä¼šè¯ç®¡ç†                        â”‚
â”‚  â”œâ”€â”€ å¯¹è¯æ¨¡å¼ â†’ Ollama API (http://localhost:11434)        â”‚
â”‚  â””â”€â”€ åˆ†ææ¨¡å¼ â†’ Pythonå­è¿›ç¨‹è°ƒç”¨                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ spawnè°ƒç”¨
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ğŸ Pythonåˆ†æå±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  agent_executor.py: LangChainæ™ºèƒ½ä»£ç†                      â”‚
â”‚  â”œâ”€â”€ æ„å›¾åˆ†æ â†’ Ollama/å¤–éƒ¨LLM                             â”‚
â”‚  â”œâ”€â”€ ä»»åŠ¡æ‰§è¡Œ â†’ single_cell_processor.py                   â”‚
â”‚  â””â”€â”€ ç»“æœè¿”å› â†’ JSONæ ¼å¼                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ æ•°æ®å¤„ç†
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ğŸ“Š æ•°æ®å¤„ç†å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  single_cell_processor.py: æ ¸å¿ƒåˆ†æå¼•æ“                    â”‚
â”‚  â”œâ”€â”€ scanpy: å•ç»†èƒæ•°æ®å¤„ç†                                â”‚
â”‚  â”œâ”€â”€ é™ç»´ç®—æ³•: UMAP, t-SNE                                 â”‚
â”‚  â””â”€â”€ å¯è§†åŒ–æ•°æ®ç”Ÿæˆ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                      âš¡ æœ¬åœ°AIæœåŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ğŸ¤– OllamaæœåŠ¡                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç«¯å£: 11434                                               â”‚
â”‚  æ¨¡å‹: gemma3:4b                                           â”‚
â”‚  åŠŸèƒ½: è‡ªç„¶è¯­è¨€ç†è§£å’Œå¯¹è¯ç”Ÿæˆ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµè¯¦è§£

### 1. å¯¹è¯æ¨¡å¼æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ Next.jså‰ç«¯ â†’ chat-ollama.js â†’ processDirectChat()
         â†“
callOllamaForChat() â†’ Ollama API â†’ è¿”å›å¯¹è¯ç»“æœ â†’ å‰ç«¯æ˜¾ç¤º
```

### 2. åˆ†ææ¨¡å¼æµç¨‹

```
æ–‡ä»¶ä¸Šä¼  + åˆ†æè¯·æ±‚ â†’ Next.jså‰ç«¯ â†’ chat-ollama.js â†’ runAgentExecutor()
                    â†“
         åˆ›å»ºä¸´æ—¶æŸ¥è¯¢æ–‡ä»¶ (è§£å†³ä¸­æ–‡ç¼–ç é—®é¢˜)
                    â†“
conda run -n bio python agent_executor.py --query_file tmp/query.txt --file_path data.h5ad
                    â†“
         analyze_user_intent() â†’ Ollamaåˆ†æç”¨æˆ·æ„å›¾ â†’ è¿”å›JSONæ‰§è¡Œè®¡åˆ’
                    â†“
         execute_action() â†’ æ ¹æ®è®¡åˆ’è°ƒç”¨ç›¸åº”å‡½æ•°
                    â†“
         single_cell_processor.py â†’ scanpyå¤„ç†æ•°æ® â†’ ç”Ÿæˆå¯è§†åŒ–æ•°æ®
                    â†“
         è¿”å›JSONç»“æœ â†’ Node.jsè§£æ â†’ å‰ç«¯æ˜¾ç¤ºå›¾è¡¨
```

## ğŸ§© æ ¸å¿ƒç»„ä»¶è¯¦è§£

### Frontend Components

#### `UnifiedChat.js`

- **èŒè´£**: ç»Ÿä¸€èŠå¤©ç»„ä»¶ï¼ˆæ•´åˆäº†ChatPanelã€ChatInputã€MessageListï¼‰
- **åŠŸèƒ½**: æ¶ˆæ¯å‘é€ã€æ–‡ä»¶ä¸Šä¼ ã€æ‹–æ‹½ä¸Šä¼ ã€æ‚¬æµ®æ–‡ä»¶åˆ—è¡¨
- **çŠ¶æ€ç®¡ç†**: ä¼šè¯å†å²ã€åŠ è½½çŠ¶æ€ã€æ–‡ä»¶ç®¡ç†
- **ä¼˜åŠ¿**: å•æ–‡ä»¶ç®¡ç†ï¼Œé¿å…ç»„ä»¶é—´å¤æ‚é€šä¿¡

#### `SingleCellAnalyzer.js`

- **èŒè´£**: æ•°æ®åˆ†ææ§åˆ¶é¢æ¿
- **åŠŸèƒ½**: æ–‡ä»¶é€‰æ‹©ã€åˆ†æå‚æ•°é…ç½®
- **é›†æˆ**: ä¸ ChatPanel åä½œ

#### `DeckGLScatterPlot.js`

- **èŒè´£**: é«˜æ€§èƒ½æ•°æ®å¯è§†åŒ–
- **æŠ€æœ¯**: DeckGL WebGL æ¸²æŸ“
- **ç‰¹æ€§**: äº¤äº’å¼æ•£ç‚¹å›¾ã€ç¼©æ”¾ã€é€‰æ‹©

### Backend APIs

#### `chat-ollama.js`

```javascript
// æ ¸å¿ƒè·¯ç”±å‡½æ•°
export default async function handler(req, res) {
  // 1. è§£æè¯·æ±‚ (multipart/form-data)
  // 2. ä¼šè¯ç®¡ç†
  // 3. æ¨¡å¼åˆ¤æ–­ (å¯¹è¯ vs åˆ†æ)
  // 4. ç»“æœå¤„ç†å’Œè¿”å›
}

// å…³é”®å‡½æ•°
- runAgentExecutor(): Pythonå­è¿›ç¨‹è°ƒç”¨
- processDirectChat(): ç›´æ¥å¯¹è¯å¤„ç†
- callOllamaForChat(): Ollama APIè°ƒç”¨
```

### Python Analysis Engine

#### `agent_executor.py`

```python
# LangChainæ™ºèƒ½ä»£ç†
def main():
    # 1. å‚æ•°è§£æ (æ”¯æŒæ–‡ä»¶è¾“å…¥é¿å…ç¼–ç é—®é¢˜)
    # 2. LLMæ„å›¾åˆ†æ
    # 3. ä»»åŠ¡æ‰§è¡Œ
    # 4. ç»“æœè¾“å‡º (JSONæ ¼å¼)

# æ ¸å¿ƒå‡½æ•°
- analyze_user_intent(): ä½¿ç”¨LLMç†è§£ç”¨æˆ·éœ€æ±‚
- execute_action(): æ ¹æ®æ„å›¾æ‰§è¡Œç›¸åº”æ“ä½œ
- get_file_summary(): æ•°æ®æ‘˜è¦ç”Ÿæˆ
- run_dimensionality_analysis(): é™ç»´åˆ†æè°ƒç”¨
```

#### `single_cell_processor.py`

```python
# å•ç»†èƒæ•°æ®å¤„ç†æ ¸å¿ƒ
class OptimizedSingleCellProcessor:
    def process_h5ad(self, file_path, method, color_by):
        # 1. æ•°æ®åŠ è½½å’Œé¢„å¤„ç†
        # 2. é™ç»´è®¡ç®— (UMAP/t-SNE)
        # 3. å¯è§†åŒ–æ•°æ®ç”Ÿæˆ
        # 4. ç»“æœè¾“å‡º (å¸¦æ ‡è®°çš„JSON)
```

## ğŸ”§ å…³é”®æŠ€æœ¯å†³ç­–

### 1. ç¼–ç é—®é¢˜è§£å†³æ–¹æ¡ˆ

**é—®é¢˜**: Windows ä¸‹ä¸­æ–‡å‚æ•°ä¼ é€’ç»™ Python æ—¶å‡ºç°ç¼–ç é”™è¯¯
**è§£å†³**:

- Node.js å†™å…¥ä¸´æ—¶æ–‡ä»¶ (UTF-8 ç¼–ç )
- Python ä»æ–‡ä»¶è¯»å–å‚æ•°
- æ‰§è¡Œå®Œæˆåæ¸…ç†ä¸´æ—¶æ–‡ä»¶

### 2. è¿›ç¨‹é—´é€šä¿¡

**æ–¹æ¡ˆ**: spawn å­è¿›ç¨‹ + JSON é€šä¿¡
**ä¼˜åŠ¿**:

- éš”ç¦» Python ç¯å¢ƒ
- æ”¯æŒ conda ç¯å¢ƒ
- é”™è¯¯å¤„ç†æ˜ç¡®

### 3. AI æœåŠ¡æ¶æ„

**æœ¬åœ°ä¼˜å…ˆ**: Ollama (æ— éœ€ API å¯†é’¥)
**äº‘ç«¯å¤‡é€‰**: æ”¯æŒ Zhipu APIã€OpenAI API
**æ™ºèƒ½åˆ‡æ¢**: æ ¹æ®ç¯å¢ƒå˜é‡è‡ªåŠ¨é€‰æ‹©

### 4. æ•°æ®æ ¼å¼æ ‡å‡†åŒ–

**ç»Ÿä¸€æ ¼å¼**: H5AD ä½œä¸ºå†…éƒ¨æ ‡å‡†
**å…¼å®¹æ€§**: æ”¯æŒ CSV/TSV è‡ªåŠ¨è½¬æ¢
**ä¼˜åŒ–**: å†…å­˜é«˜æ•ˆçš„å¤„ç†æµç¨‹

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†ç­–ç•¥

### Frontend

```javascript
// å¤šå±‚é”™è¯¯æ•è·
try {
  const response = await fetch('/api/chat-ollama', {...});
  const data = await response.json();
  if (!data.success) {
    throw new Error(data.message);
  }
} catch (error) {
  // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
}
```

### Backend

```javascript
// å­è¿›ç¨‹é”™è¯¯å¤„ç†
pythonProcess.on("error", (err) => {
  console.error("å¯åŠ¨Pythonè¿›ç¨‹å¤±è´¥:", err);
  reject(new Error("æ— æ³•å¯åŠ¨Pythonå­è¿›ç¨‹"));
});

pythonProcess.on("close", (code) => {
  if (code !== 0) {
    return reject(new Error(`Pythonè„šæœ¬æ‰§è¡Œå¤±è´¥: ${stderrData}`));
  }
});
```

### Python

```python
# å¼‚å¸¸æ•è·å’ŒJSONè¾“å‡º
try:
    result = execute_action(action_plan)
    print(json.dumps(result, ensure_ascii=False))
except Exception as e:
    error_result = {"error": f"æ‰§è¡Œå¤±è´¥: {str(e)}", "success": False}
    print(json.dumps(error_result, ensure_ascii=False))
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç‚¹

### 1. å‰ç«¯ä¼˜åŒ–

- ç»„ä»¶æ‡’åŠ è½½
- å¤§æ•°æ®é›†è™šæ‹Ÿæ»šåŠ¨
- WebGL åŠ é€Ÿæ¸²æŸ“

### 2. åç«¯ä¼˜åŒ–

- ä¼šè¯å¤ç”¨
- ä¸´æ—¶æ–‡ä»¶åŠæ—¶æ¸…ç†
- å¹¶å‘è¯·æ±‚æ§åˆ¶

### 3. Python ä¼˜åŒ–

- scanpy é«˜æ•ˆæ•°æ®ç»“æ„
- å†…å­˜ç®¡ç†ä¼˜åŒ–
- GPU åŠ é€Ÿ (å¦‚æœå¯ç”¨)

## ğŸ”® æ‰©å±•æ€§è®¾è®¡

### 1. æ–°å¢åˆ†ææ–¹æ³•

```python
# åœ¨single_cell_processor.pyä¸­æ·»åŠ æ–°æ–¹æ³•
def new_analysis_method(self, params):
    # å®ç°æ–°çš„åˆ†æé€»è¾‘
    return results

# åœ¨agent_executor.pyä¸­æ³¨å†Œ
def execute_action(action_plan):
    if action == "new_analysis":
        return new_analysis_method(params)
```

### 2. æ–°å¢ AI æ¨¡å‹

```javascript
// åœ¨config/index.jsä¸­é…ç½®
ai: {
  newModel: {
    baseUrl: "http://localhost:xxxx",
    model: "new-model:latest"
  }
}
```

### 3. æ–°å¢æ•°æ®æ ¼å¼

```python
# æ‰©å±•æ–‡ä»¶è¯»å–é€»è¾‘
def read_data_file(file_path):
    ext = os.path.splitext(file_path)[1]
    if ext == '.new_format':
        return read_new_format(file_path)
```

---

è¿™ä¸ªæ¶æ„è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„**å¯ç»´æŠ¤æ€§**ã€**å¯æ‰©å±•æ€§**å’Œ**ç”¨æˆ·å‹å¥½æ€§**ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„æ€§èƒ½å’Œé”™è¯¯å¤„ç†èƒ½åŠ›ã€‚
