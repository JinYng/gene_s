â— ğŸ§¬ åŸºäºåˆ†æè¯·æ±‚çš„ç«¯åˆ°ç«¯æ•°æ®æµè¿½è¸ªåŠæ¶æ„è§£è¯»

  åŸºäºå¯¹æ‚¨çš„ä»£ç åº“çš„æ·±å…¥åˆ†æï¼Œæˆ‘å°†ä»ä¸€ä¸ªå…·ä½“çš„åˆ†æè¯·æ±‚åœºæ™¯å‡ºå‘ï¼Œè¯¦ç»†è¿½è¸ªæ•°æ®æµåŠ¨ï¼Œå¹¶è§£è¯»å…³é”®æ¶æ„ç»„ä»¶ã€‚

  ğŸ“‹ ç«¯åˆ°ç«¯æ•°æ®æµè¿½è¸ªï¼šå•ç»†èƒåˆ†æè¯·æ±‚

  ğŸ¯ åœºæ™¯ï¼šç”¨æˆ·ä¸Šä¼ H5ADæ–‡ä»¶å¹¶è¯·æ±‚"è¿›è¡ŒUMAPé™ç»´åˆ†æ"

  1ï¸âƒ£ å‰ç«¯ç”¨æˆ·äº¤äº’å±‚ï¼ˆModernUnifiedChatï¼‰

- ä½ç½®: components/chat/ModernUnifiedChat.js:478-684
- èŒè´£: ç°ä»£åŒ–èŠå¤©ç•Œé¢ï¼Œç±»ä¼¼ChatGPTçš„ç”¨æˆ·ä½“éªŒ
- æ•°æ®æµ:
  - ç”¨æˆ·é€šè¿‡ ModernChatInput ç»„ä»¶ä¸Šä¼ æ–‡ä»¶å’Œè¾“å…¥æ–‡æœ¬
  - handleSendMessage() å‡½æ•°å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œåˆ›å»ºåŒ…å«æ–‡ä»¶ä¿¡æ¯çš„æ¶ˆæ¯å¯¹è±¡
  - å…³é”®æ•°æ®ç»“æ„ï¼š
    messageContent = {
    text: "è¿›è¡ŒUMAPé™ç»´åˆ†æ",
    files: [{ name: "data.h5ad", size: 1024000, type: "..." }]
    }

  2ï¸âƒ£ çŠ¶æ€ç®¡ç†å±‚ï¼ˆChatAnalyzerï¼‰

- ä½ç½®: components/chat/ChatAnalyzer.js:62-144
- èŒè´£: ç®¡ç†ä¼šè¯çŠ¶æ€ã€åè°ƒç»„ä»¶äº¤äº’ã€å¤„ç†ä¸åŒæ¨¡å¼
- å…³é”®é€»è¾‘:
  - handleSendMessage() æ¥æ”¶æ¥è‡ªUIçš„æ¶ˆæ¯å’ŒåŸå§‹Fileå¯¹è±¡
  - æ ¹æ®æ–‡ä»¶å­˜åœ¨åˆ¤æ–­å¤„ç†è·¯å¾„ï¼š
    - æœ‰æ–‡ä»¶ â†’ è°ƒç”¨ uploadFilesAndAnalyze() (ç¬¬146-193è¡Œ)
    - çº¯æ–‡æœ¬ â†’ è°ƒç”¨ chatService.sendMessage()
  - ä¼šè¯ç®¡ç†ï¼šç»´æŠ¤sessionIdã€æ¶ˆæ¯å†å²ã€å¯è§†åŒ–æ•°æ®çŠ¶æ€

  3ï¸âƒ£ æœåŠ¡å±‚å°è£…ï¼ˆchatServiceï¼‰

- ä½ç½®: services/chatService.js:16-79
- èŒè´£: ç»Ÿä¸€çš„APIè°ƒç”¨æ¥å£ï¼Œæ”¯æŒå¤šç§AIæœåŠ¡
- å¤„ç†æµç¨‹:
  - æ„å»ºFormDataï¼Œå°†Fileå¯¹è±¡å’Œå…ƒæ•°æ®æ‰“åŒ…
  - ç¡®å®šAPIç«¯ç‚¹ï¼ˆé€šè¿‡ useEnhancedWorkflow å‚æ•°ï¼‰
  - å‘é€HTTP POSTè¯·æ±‚åˆ°Next.js APIè·¯ç”±

  4ï¸âƒ£ Next.js APIä¸­é—´å±‚ï¼ˆ/api/chat-ollamaï¼‰

- ä½ç½®: pages/api/chat-ollama.js:19-307
- èŒè´£: ç»Ÿä¸€çš„è¯·æ±‚å¤„ç†å…¥å£ï¼Œæ”¯æŒåŒæ¨¡å¼æ“ä½œ
- æ ¸å¿ƒå¤„ç†é€»è¾‘:
- æ–‡ä»¶è§£æé˜¶æ®µï¼ˆç¬¬33-54è¡Œï¼‰:
  const form = formidable({
  uploadDir: tempDir,
  maxFileSize: 2GB,
  multiples: true
  });
  const [fields, files] = await form.parse(req);
- è·¯ç”±å†³ç­–ï¼ˆç¬¬129-137è¡Œï¼‰:
  if (useWorkflow && (uploadedFiles.length > 0 ||
  message.includes("åˆ†æ") || message.includes("é™ç»´"))) {
  // è°ƒç”¨Pythonåˆ†ææœåŠ¡
  callAnalysisServer(message, mainFilePath, sessionId)
  } else {
  // ç›´æ¥Ollamaå¯¹è¯
  processDirectChat(message, session, uploadedFiles)
  }

  5ï¸âƒ£ Python FastAPIæœåŠ¡æ¡¥æ¥

- ä½ç½®: chat_scripts/main.py:69-135
- èŒè´£: æ¥æ”¶Next.jsè¯·æ±‚ï¼Œè°ƒç”¨Pythonåˆ†æè„šæœ¬
- å¤„ç†æµç¨‹:
  - æ¥æ”¶ /analyze POSTè¯·æ±‚
  - é€šè¿‡subprocessè°ƒç”¨ agent_executor.py
  - å¤„ç†ä¸­æ–‡ç¼–ç å’Œå¼‚å¸¸æƒ…å†µ

  6ï¸âƒ£ AIä»£ç†å±‚ï¼ˆLangChain Agentï¼‰

- ä½ç½®: chat_scripts/agent_executor.py:111-218
- èŒè´£: è‡ªç„¶è¯­è¨€ç†è§£ï¼Œå†³ç­–æ‰§è¡Œè·¯å¾„
- æ™ºèƒ½å¤„ç†:
  def analyze_user_intent(query: str):# ä½¿ç”¨ChatOllamaï¼ˆgemma3:4bï¼‰åˆ†æç”¨æˆ·æ„å›¾

  # è¾“å‡ºç»“æ„åŒ–JSONï¼š

  {
  "action_type": "single_cell_analysis",
  "arguments": {
  "method": "umap",
  "output_path": "output/umap_result.png",
  "params": {}
  }
  }

  7ï¸âƒ£ æ•°æ®å¤„ç†å¼•æ“

- ä½ç½®: chat_scripts/single_cell_processor.py:163-199
- èŒè´£: æ ¸å¿ƒå•ç»†èƒæ•°æ®åˆ†æ
- å¤„ç†æµç¨‹:
  def process_h5ad(h5ad_input, reduction_method, color_by):

  # 1. åŠ è½½H5ADæ–‡ä»¶

  self.adata = sc.read_h5ad(h5ad_input)

  # 2. å¿«é€Ÿé¢„å¤„ç†

  self._quick_preprocess()  # è¿‡æ»¤ã€æ ‡å‡†åŒ–ã€é«˜å˜åŸºå› 

  # 3. é™ç»´åˆ†æ

  sc.tl.pca(self.adata)
  sc.pp.neighbors(self.adata)
  sc.tl.umap(self.adata)  # æˆ–t-SNE

  # 4. ç”Ÿæˆå¯è§†åŒ–æ•°æ®

  return self._generate_plot_data(method, color_by)

  8ï¸âƒ£ å“åº”æ•°æ®å›ä¼ 

- æ•°æ®æ ¼å¼:
  {
  "success": true,
  "data": {
  "x": [2.3, 1.8, ...],        // UMAP Xåæ ‡
  "y": [1.5, -0.7, ...],       // UMAP Yåæ ‡
  "color_values": [0, 1, 2, ...], // èšç±»æ ‡ç­¾
  "color_type": "categorical",
  "categories": ["Cluster1", "Cluster2", ...],
  "n_cells": 5000,
  "method": "UMAP"
  }
  }

  9ï¸âƒ£ å‰ç«¯å¯è§†åŒ–æ¸²æŸ“

- ä½ç½®: components/analysis/DeckGLScatterPlot.js
- æŠ€æœ¯: ä½¿ç”¨DeckGLè¿›è¡Œé«˜æ€§èƒ½WebGLæ•£ç‚¹å›¾æ¸²æŸ“
- çŠ¶æ€æ›´æ–°: setVisualizationData() è§¦å‘å¯è§†åŒ–é¢æ¿æ›´æ–°

---

  ğŸ—‚ï¸ å…³é”®ç›®å½•ç»“æ„è§£è¯»

  components/ - UIç»„ä»¶åº“

  components/
  â”œâ”€â”€ chat/                    # èŠå¤©ç›¸å…³ç»„ä»¶
  â”‚   â”œâ”€â”€ ModernUnifiedChat.js # ä¸»èŠå¤©ç•Œé¢ï¼ˆChatGPTé£æ ¼ï¼‰
  â”‚   â”œâ”€â”€ ChatAnalyzer.js      # çŠ¶æ€ç®¡ç†å’Œä¸šåŠ¡é€»è¾‘
  â”‚   â”œâ”€â”€ AIServiceSelector.js # AIæœåŠ¡åˆ‡æ¢
  â”‚   â””â”€â”€ VisualizationPanel.js # æ•°æ®å¯è§†åŒ–é¢æ¿
  â”œâ”€â”€ analysis/                # åˆ†æå·¥å…·ç»„ä»¶
  â”‚   â”œâ”€â”€ DeckGLScatterPlot.js # WebGLæ•£ç‚¹å›¾ç»„ä»¶
  â”‚   â”œâ”€â”€ SingleCellAnalyzer.js # å•ç»†èƒåˆ†ææ§åˆ¶é¢æ¿
  â”‚   â””â”€â”€ SeparateFileUploader.js # ç‹¬ç«‹æ–‡ä»¶ä¸Šä¼ å™¨
  â””â”€â”€ layout/                  # å¸ƒå±€æ§åˆ¶ç»„ä»¶
      â”œâ”€â”€ LayoutController.js  # é¡µé¢è·¯ç”±æ§åˆ¶å™¨
      â”œâ”€â”€ BioChat.js          # BioChatç•Œé¢å¸ƒå±€
      â””â”€â”€ UpToDown.js         # åˆ†æç•Œé¢å¸ƒå±€

  pages/api/ - Next.jsåç«¯API

  pages/api/
  â”œâ”€â”€ chat-ollama.js          # ğŸ¯ æ ¸å¿ƒAPIï¼šç»Ÿä¸€èŠå¤©å’Œåˆ†æå…¥å£
  â”œâ”€â”€ process-single-cell.js  # ç›´æ¥å•ç»†èƒåˆ†æç«¯ç‚¹
  â”œâ”€â”€ convert-to-h5ad.js      # æ–‡ä»¶æ ¼å¼è½¬æ¢
  â”œâ”€â”€ upload-file.js          # é€šç”¨æ–‡ä»¶ä¸Šä¼ 
  â”œâ”€â”€ health.js               # ç³»ç»Ÿå¥åº·æ£€æŸ¥
  â””â”€â”€ check-zhipu-availability.js # AIæœåŠ¡å¯ç”¨æ€§æ£€æŸ¥

  services/ - å‰ç«¯æœåŠ¡å±‚

  services/
  â”œâ”€â”€ chatService.js          # ç»Ÿä¸€èŠå¤©APIå°è£…
  â”œâ”€â”€ aiServiceManager.js     # AIæœåŠ¡ç®¡ç†å™¨
  â”œâ”€â”€ FileService.js          # æ–‡ä»¶æ“ä½œæœåŠ¡
  â””â”€â”€ base/BaseService.js     # æœåŠ¡åŸºç±»

  lib/ - å·¥å…·åº“

  lib/
  â”œâ”€â”€ errorHandler.js         # ç»Ÿä¸€é”™è¯¯å¤„ç†
  â”œâ”€â”€ logger.js              # æ—¥å¿—ç³»ç»Ÿ
  â”œâ”€â”€ middleware.js          # ä¸­é—´ä»¶å‡½æ•°
  â”œâ”€â”€ utils.js               # é€šç”¨å·¥å…·å‡½æ•°
  â”œâ”€â”€ utils-client.js        # å®¢æˆ·ç«¯å·¥å…·
  â””â”€â”€ utils-server.js        # æœåŠ¡ç«¯å·¥å…·

  chat_scripts/ - Pythonåˆ†ææœåŠ¡

  â”œâ”€â”€ main.py                 # FastAPIæœåŠ¡å™¨å…¥å£ï¼ˆ8001ç«¯å£ï¼‰
  â”œâ”€â”€ agent_executor.py       # LangChainæ™ºèƒ½ä»£ç†
  â”œâ”€â”€ single_cell_processor.py # æ ¸å¿ƒæ•°æ®å¤„ç†å¼•æ“
  â”œâ”€â”€ matrix_converter.py     # æ–‡ä»¶æ ¼å¼è½¬æ¢å™¨
  â”œâ”€â”€ error_handler.py        # Pythoné”™è¯¯å¤„ç†
  â””â”€â”€ requirements.txt        # Pythonä¾èµ–

  analysis_scripts/ - æ•°æ®å¤„ç†è„šæœ¬

  analysis_scripts/
  â”œâ”€â”€ single_cell_processor.py # å•ç»†èƒåˆ†ææ ¸å¿ƒé€»è¾‘
  â””â”€â”€ matrix_to_h5ad_converter.py # çŸ©é˜µæ ¼å¼è½¬æ¢å™¨

---

  ğŸ”„ æ¶æ„ç‰¹ç‚¹æ€»ç»“

1. ç®€åŒ–çš„å…¨æ ˆæ¶æ„

- ç»Ÿä¸€å…¥å£: å•ä¸ªNext.jsåº”ç”¨åŒæ—¶å¤„ç†å‰ç«¯å’ŒAPI
- åŒæ¨¡å¼æ“ä½œ: /api/chat-ollama æ”¯æŒçº¯å¯¹è¯å’Œæ•°æ®åˆ†æä¸¤ç§æ¨¡å¼
- ç›´æ¥å­è¿›ç¨‹è°ƒç”¨: æ— éœ€ç‹¬ç«‹åç«¯æœåŠ¡ï¼Œç›´æ¥è°ƒç”¨Pythonè„šæœ¬

2. æ™ºèƒ½è·¯ç”±æœºåˆ¶

- åŸºäºå†…å®¹çš„è·¯ç”±: æ ¹æ®æ¶ˆæ¯å†…å®¹å’Œæ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨é€‰æ‹©å¤„ç†è·¯å¾„
- å·¥ä½œæµæ ‡è¯†: useWorkflow å‚æ•°æ§åˆ¶æ˜¯å¦å¯ç”¨æ•°æ®åˆ†ææµç¨‹
- æœåŠ¡é™çº§: AIè§£æå¤±è´¥æ—¶çš„å…³é”®è¯å›é€€æœºåˆ¶

3. å¤šå±‚æ¬¡é”™è¯¯å¤„ç†

- ç»Ÿä¸€é”™è¯¯å¤„ç†: lib/errorHandler.js å’Œ chat_scripts/error_handler.py
- é”™è¯¯åˆ†ç±»: åŒºåˆ†éªŒè¯é”™è¯¯ã€æœåŠ¡é”™è¯¯ã€è¶…æ—¶é”™è¯¯ç­‰
- ç”¨æˆ·å‹å¥½: é”™è¯¯ä¿¡æ¯ä¸­æ–‡åŒ–ï¼ŒåŒ…å«è§£å†³å»ºè®®

4. é«˜æ€§èƒ½æ•°æ®å¯è§†åŒ–

- WebGLæ¸²æŸ“: ä½¿ç”¨DeckGLå¤„ç†å¤§è§„æ¨¡ç»†èƒæ•°æ®
- æµå¼æ›´æ–°: åˆ†æç»“æœé€æ­¥æ˜¾ç¤ºï¼Œæ¨¡æ‹Ÿå¯¹è¯æ„Ÿ
- å†…å­˜ä¼˜åŒ–: æ•°æ®åœ¨Pythonä¸­å¤„ç†ï¼Œå‰ç«¯åªæ¥æ”¶åæ ‡æ•°æ®

5. çµæ´»çš„é…ç½®ç®¡ç†

- ç»Ÿä¸€é…ç½®: config/index.js é›†ä¸­ç®¡ç†æ‰€æœ‰æœåŠ¡é…ç½®
- ç¯å¢ƒé€‚é…: å¼€å‘ã€ç”Ÿäº§ã€æµ‹è¯•ç¯å¢ƒçš„å·®å¼‚åŒ–é…ç½®
- è¿è¡Œæ—¶éªŒè¯: å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯é…ç½®æœ‰æ•ˆæ€§

  è¿™ä¸ªæ¶æ„çš„æœ€å¤§ä¼˜åŠ¿åœ¨äºç®€æ´è€Œå¼ºå¤§ï¼šç”¨æˆ·åªéœ€å¯åŠ¨ä¸¤ä¸ªæœåŠ¡ï¼ˆOllama +
  Next.jsï¼‰ï¼Œå°±èƒ½è·å¾—å®Œæ•´çš„AIé©±åŠ¨å•ç»†èƒæ•°æ®åˆ†æèƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒäº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚
